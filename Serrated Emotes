--[[
    $errated Emotes - Advanced Roblox Emote Script
    Features: Modern UI, Smooth Animations, Full Emote Catalog, Favorites, Speed Control
    Fixed Version with Full Functionality
]]

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local AvatarEditorService = game:GetService("AvatarEditorService")

-- Utility function for missing functions
local function missing(t, f, fallback)
    if type(f) == t then return f end
    return fallback 
end

local cloneref = missing("function", cloneref, function(...) return ... end)

-- Get services with cloneref protection
local function GetService(name)
    return cloneref(game:GetService(name))
end

local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

-- Screen scaling function
local Screen = workspace.CurrentCamera.ViewportSize
local function scale(axis, value)
    local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled
    local baseWidth, baseHeight = 1920, 1080
    local scaleFactor = isMobile and 2 or 1.5

    if axis == "X" then
        return value * (Screen.X / baseWidth) * scaleFactor
    elseif axis == "Y" then
        return value * (Screen.Y / baseHeight) * scaleFactor
    end
end

-- Configuration
local Config = {
    ToggleKey = Enum.KeyCode.G,
    UIEnabled = true,
    LoopEmote = true,
    MoveWhileEmoting = false,
    EmoteSpeed = 1,
    FavoriteEmotes = {},
    LastTab = "Browse",
    StopEmoteWhenMoving = true,
    FadeIn = 0.1,
    FadeOut = 0.1,
    Weight = 1,
    TimePosition = 0,
    StopOtherAnimations = true
}

local SAVE_FILE = "SerratedEmotes_Config.json"

-- Load saved config
local function LoadConfig()
    local success, data = pcall(function()
        if readfile and isfile and isfile(SAVE_FILE) then
            return HttpService:JSONDecode(readfile(SAVE_FILE))
        end
        return nil
    end)
    if success and data and type(data) == "table" then
        for k, v in pairs(data) do
            Config[k] = v
        end
    end
end

-- Save config
local function SaveConfig()
    pcall(function()
        if writefile then
            writefile(SAVE_FILE, HttpService:JSONEncode(Config))
        end
    end)
end

-- Try to load config
pcall(LoadConfig)

-- Variables
local CurrentEmote = nil
local EmotesList = {}
local FilteredEmotes = {}
local UIVisible = true
local CurrentlyPlaying = false
local IsLoadingEmotes = false
local lastPosition = HumanoidRootPart.Position

-- Welcome messages
local WelcomeMessages = {
    "Welcome back, %s!",
    "Hey there, %s!",
    "What's up, %s?",
    "Ready to emote, %s?",
    "Let's dance, %s!",
    "Time to vibe, %s!",
    "Looking good, %s!",
    "Let's go, %s!"
}

-- UI Creation
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SerratedEmotes"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false

-- Protection
if gethui then
    ScreenGui.Parent = gethui()
elseif syn and syn.protect_gui then
    syn.protect_gui(ScreenGui)
    ScreenGui.Parent = CoreGui
else
    ScreenGui.Parent = CoreGui
end

-- Main Frame
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 700, 0, 500)
MainFrame.Position = UDim2.new(0.5, -350, 0.5, -250)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true
MainFrame.Active = true
MainFrame.Parent = ScreenGui

-- Add corner
local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 15)
MainCorner.Parent = MainFrame

-- Add gradient
local MainGradient = Instance.new("UIGradient")
MainGradient.Color = ColorSequence.new(Color3.fromRGB(255, 255, 255), Color3.fromRGB(255, 255, 255))
MainGradient.Transparency = NumberSequence.new{
    NumberSequenceKeypoint.new(0, 0.05),
    NumberSequenceKeypoint.new(1, 0.1)
}
MainGradient.Parent = MainFrame

-- Top Bar
local TopBar = Instance.new("Frame")
TopBar.Name = "TopBar"
TopBar.Size = UDim2.new(1, 0, 0, 50)
TopBar.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
TopBar.BorderSizePixel = 0
TopBar.Parent = MainFrame

local TopBarCorner = Instance.new("UICorner")
TopBarCorner.CornerRadius = UDim.new(0, 15)
TopBarCorner.Parent = TopBar

-- Fix corner on bottom
local TopBarFix = Instance.new("Frame")
TopBarFix.Size = UDim2.new(1, 0, 0, 15)
TopBarFix.Position = UDim2.new(0, 0, 1, -15)
TopBarFix.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
TopBarFix.BorderSizePixel = 0
TopBarFix.Parent = TopBar

-- Title
local Title = Instance.new("TextLabel")
Title.Name = "Title"
Title.Size = UDim2.new(0, 200, 1, 0)
Title.Position = UDim2.new(0, 15, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "$errated Emotes"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 20
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = TopBar

-- Add gradient to title
local TitleGradient = Instance.new("UIGradient")
TitleGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(138, 43, 226)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(75, 0, 130))
}
TitleGradient.Parent = Title

-- Loading indicator
local LoadingIndicator = Instance.new("TextLabel")
LoadingIndicator.Name = "LoadingIndicator"
LoadingIndicator.Size = UDim2.new(0, 150, 1, 0)
LoadingIndicator.Position = UDim2.new(0, 220, 0, 0)
LoadingIndicator.BackgroundTransparency = 1
LoadingIndicator.Text = ""
LoadingIndicator.TextColor3 = Color3.fromRGB(138, 43, 226)
LoadingIndicator.TextSize = 12
LoadingIndicator.Font = Enum.Font.Gotham
LoadingIndicator.TextXAlignment = Enum.TextXAlignment.Left
LoadingIndicator.Visible = false
LoadingIndicator.Parent = TopBar

-- Control buttons
local ButtonsFrame = Instance.new("Frame")
ButtonsFrame.Name = "ButtonsFrame"
ButtonsFrame.Size = UDim2.new(0, 100, 1, 0)
ButtonsFrame.Position = UDim2.new(1, -110, 0, 0)
ButtonsFrame.BackgroundTransparency = 1
ButtonsFrame.Parent = TopBar

local function CreateControlButton(text, position)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0, 30, 0, 30)
    button.Position = UDim2.new(0, position, 0.5, -15)
    button.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    button.BorderSizePixel = 0
    button.Text = text
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = 18
    button.Font = Enum.Font.GothamBold
    button.Parent = ButtonsFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button
    
    return button
end

local MinimizeBtn = CreateControlButton("‚àí", 0)
local CloseBtn = CreateControlButton("√ó", 70)

-- Content Container
local ContentContainer = Instance.new("Frame")
ContentContainer.Name = "ContentContainer"
ContentContainer.Size = UDim2.new(1, 0, 1, -50)
ContentContainer.Position = UDim2.new(0, 0, 0, 50)
ContentContainer.BackgroundTransparency = 1
ContentContainer.Parent = MainFrame

-- Sidebar
local Sidebar = Instance.new("Frame")
Sidebar.Name = "Sidebar"
Sidebar.Size = UDim2.new(0, 200, 1, 0)
Sidebar.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
Sidebar.BorderSizePixel = 0
Sidebar.Parent = ContentContainer

-- Avatar Preview Container
local AvatarContainer = Instance.new("Frame")
AvatarContainer.Name = "AvatarContainer"
AvatarContainer.Size = UDim2.new(1, -20, 0, 180)
AvatarContainer.Position = UDim2.new(0, 10, 0, 10)
AvatarContainer.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
AvatarContainer.BorderSizePixel = 0
AvatarContainer.Parent = Sidebar

local AvatarCorner = Instance.new("UICorner")
AvatarCorner.CornerRadius = UDim.new(0, 10)
AvatarCorner.Parent = AvatarContainer

-- Avatar Image
local AvatarImage = Instance.new("ImageLabel")
AvatarImage.Name = "AvatarImage"
AvatarImage.Size = UDim2.new(0, 100, 0, 100)
AvatarImage.Position = UDim2.new(0.5, -50, 0, 15)
AvatarImage.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
AvatarImage.BorderSizePixel = 0
AvatarImage.Image = Players:GetUserThumbnailAsync(Player.UserId, Enum.ThumbnailType.AvatarBust, Enum.ThumbnailSize.Size150x150)
AvatarImage.Parent = AvatarContainer

local AvatarImageCorner = Instance.new("UICorner")
AvatarImageCorner.CornerRadius = UDim.new(1, 0)
AvatarImageCorner.Parent = AvatarImage

-- Welcome Text
local WelcomeText = Instance.new("TextLabel")
WelcomeText.Name = "WelcomeText"
WelcomeText.Size = UDim2.new(1, -10, 0, 50)
WelcomeText.Position = UDim2.new(0, 5, 0, 125)
WelcomeText.BackgroundTransparency = 1
WelcomeText.Text = string.format(WelcomeMessages[math.random(#WelcomeMessages)], Player.DisplayName)
WelcomeText.TextColor3 = Color3.fromRGB(200, 200, 200)
WelcomeText.TextSize = 14
WelcomeText.Font = Enum.Font.Gotham
WelcomeText.TextWrapped = true
WelcomeText.TextYAlignment = Enum.TextYAlignment.Top
WelcomeText.Parent = AvatarContainer

-- Tab buttons
local TabsContainer = Instance.new("Frame")
TabsContainer.Name = "TabsContainer"
TabsContainer.Size = UDim2.new(1, -20, 0, 200)
TabsContainer.Position = UDim2.new(0, 10, 0, 200)
TabsContainer.BackgroundTransparency = 1
TabsContainer.Parent = Sidebar

local function CreateTabButton(text, position, icon)
    local button = Instance.new("TextButton")
    button.Name = text .. "Tab"
    button.Size = UDim2.new(1, 0, 0, 45)
    button.Position = UDim2.new(0, 0, 0, position)
    button.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    button.BorderSizePixel = 0
    button.Text = "  " .. icon .. "  " .. text
    button.TextColor3 = Color3.fromRGB(150, 150, 150)
    button.TextSize = 15
    button.Font = Enum.Font.Gotham
    button.TextXAlignment = Enum.TextXAlignment.Left
    button.Parent = TabsContainer
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = button
    
    local padding = Instance.new("UIPadding")
    padding.PaddingLeft = UDim.new(0, 10)
    padding.Parent = button
    
    return button
end

local BrowseTab = CreateTabButton("Browse", 0, "üîç")
local FavoritesTab = CreateTabButton("Favorites", 55, "‚≠ê")
local SettingsTab = CreateTabButton("Settings", 110, "‚öôÔ∏è")

-- Main Content Area
local MainContent = Instance.new("Frame")
MainContent.Name = "MainContent"
MainContent.Size = UDim2.new(1, -210, 1, -10)
MainContent.Position = UDim2.new(0, 205, 0, 5)
MainContent.BackgroundTransparency = 1
MainContent.Parent = ContentContainer

-- Browse Page
local BrowsePage = Instance.new("Frame")
BrowsePage.Name = "BrowsePage"
BrowsePage.Size = UDim2.new(1, 0, 1, 0)
BrowsePage.BackgroundTransparency = 1
BrowsePage.Visible = true
BrowsePage.Parent = MainContent

-- Search Bar
local SearchBarContainer = Instance.new("Frame")
SearchBarContainer.Size = UDim2.new(1, 0, 0, 40)
SearchBarContainer.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
SearchBarContainer.BorderSizePixel = 0
SearchBarContainer.Parent = BrowsePage

local SearchCorner = Instance.new("UICorner")
SearchCorner.CornerRadius = UDim.new(0, 8)
SearchCorner.Parent = SearchBarContainer

local SearchBox = Instance.new("TextBox")
SearchBox.Name = "SearchBox"
SearchBox.Size = UDim2.new(1, -20, 1, 0)
SearchBox.Position = UDim2.new(0, 10, 0, 0)
SearchBox.BackgroundTransparency = 1
SearchBox.PlaceholderText = "üîç Search emotes..."
SearchBox.Text = ""
SearchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
SearchBox.PlaceholderColor3 = Color3.fromRGB(100, 100, 100)
SearchBox.TextSize = 14
SearchBox.Font = Enum.Font.Gotham
SearchBox.TextXAlignment = Enum.TextXAlignment.Left
SearchBox.ClearTextOnFocus = false
SearchBox.Parent = SearchBarContainer

-- Emotes List
local EmotesScrollFrame = Instance.new("ScrollingFrame")
EmotesScrollFrame.Name = "EmotesScrollFrame"
EmotesScrollFrame.Size = UDim2.new(1, 0, 1, -50)
EmotesScrollFrame.Position = UDim2.new(0, 0, 0, 45)
EmotesScrollFrame.BackgroundTransparency = 1
EmotesScrollFrame.BorderSizePixel = 0
EmotesScrollFrame.ScrollBarThickness = 6
EmotesScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(138, 43, 226)
EmotesScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
EmotesScrollFrame.Parent = BrowsePage

local EmotesListLayout = Instance.new("UIListLayout")
EmotesListLayout.Padding = UDim.new(0, 5)
EmotesListLayout.SortOrder = Enum.SortOrder.Name
EmotesListLayout.Parent = EmotesScrollFrame

-- Favorites Page
local FavoritesPage = Instance.new("Frame")
FavoritesPage.Name = "FavoritesPage"
FavoritesPage.Size = UDim2.new(1, 0, 1, 0)
FavoritesPage.BackgroundTransparency = 1
FavoritesPage.Visible = false
FavoritesPage.Parent = MainContent

local FavoritesScrollFrame = Instance.new("ScrollingFrame")
FavoritesScrollFrame.Name = "FavoritesScrollFrame"
FavoritesScrollFrame.Size = UDim2.new(1, 0, 1, 0)
FavoritesScrollFrame.BackgroundTransparency = 1
FavoritesScrollFrame.BorderSizePixel = 0
FavoritesScrollFrame.ScrollBarThickness = 6
FavoritesScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(138, 43, 226)
FavoritesScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
FavoritesScrollFrame.Parent = FavoritesPage

local FavoritesListLayout = Instance.new("UIListLayout")
FavoritesListLayout.Padding = UDim.new(0, 5)
FavoritesListLayout.SortOrder = Enum.SortOrder.Name
FavoritesListLayout.Parent = FavoritesScrollFrame

-- Settings Page
local SettingsPage = Instance.new("Frame")
SettingsPage.Name = "SettingsPage"
SettingsPage.Size = UDim2.new(1, 0, 1, 0)
SettingsPage.BackgroundTransparency = 1
SettingsPage.Visible = false
SettingsPage.Parent = MainContent

local SettingsScrollFrame = Instance.new("ScrollingFrame")
SettingsScrollFrame.Name = "SettingsScrollFrame"
SettingsScrollFrame.Size = UDim2.new(1, 0, 1, 0)
SettingsScrollFrame.BackgroundTransparency = 1
SettingsScrollFrame.BorderSizePixel = 0
SettingsScrollFrame.ScrollBarThickness = 6
SettingsScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(138, 43, 226)
SettingsScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
SettingsScrollFrame.Parent = SettingsPage

local SettingsListLayout = Instance.new("UIListLayout")
SettingsListLayout.Padding = UDim.new(0, 10)
SettingsListLayout.SortOrder = Enum.SortOrder.LayoutOrder
SettingsListLayout.Parent = SettingsScrollFrame

-- Watermark
local Watermark = Instance.new("TextLabel")
Watermark.Name = "Watermark"
Watermark.Size = UDim2.new(0, 150, 0, 30)
Watermark.Position = UDim2.new(1, -160, 1, -35)
Watermark.BackgroundTransparency = 1
Watermark.Text = "$errated Emotes"
Watermark.TextColor3 = Color3.fromRGB(138, 43, 226)
Watermark.TextSize = 12
Watermark.Font = Enum.Font.GothamBold
Watermark.TextXAlignment = Enum.TextXAlignment.Right
Watermark.TextTransparency = 0.5
Watermark.Parent = MainFrame

-- Animation Functions
local function SmoothTween(object, properties, duration, easingStyle, easingDirection)
    easingStyle = easingStyle or Enum.EasingStyle.Quad
    easingDirection = easingDirection or Enum.EasingDirection.Out
    
    local tweenInfo = TweenInfo.new(duration, easingStyle, easingDirection)
    local tween = TweenService:Create(object, tweenInfo, properties)
    tween:Play()
    return tween
end

-- Drag functionality
local dragging = false
local dragInput, mousePos, framePos

TopBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        mousePos = input.Position
        framePos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

TopBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - mousePos
        SmoothTween(MainFrame, {
            Position = UDim2.new(
                framePos.X.Scale,
                framePos.X.Offset + delta.X,
                framePos.Y.Scale,
                framePos.Y.Offset + delta.Y
            )
        }, 0.1, Enum.EasingStyle.Linear)
    end
end)

-- Control button functions
local minimized = false
local originalSize = MainFrame.Size

MinimizeBtn.MouseButton1Click:Connect(function()
    minimized = not minimized
    if minimized then
        SmoothTween(MainFrame, {Size = UDim2.new(0, 700, 0, 50)}, 0.3)
        ContentContainer.Visible = false
        MinimizeBtn.Text = "‚ñ°"
    else
        SmoothTween(MainFrame, {Size = originalSize}, 0.3)
        ContentContainer.Visible = true
        MinimizeBtn.Text = "‚àí"
    end
end)

CloseBtn.MouseButton1Click:Connect(function()
    SmoothTween(MainFrame, {
        Size = UDim2.new(0, 0, 0, 0),
        Position = UDim2.new(0.5, 0, 0.5, 0)
    }, 0.3)
    wait(0.3)
    ScreenGui:Destroy()
end)

-- Tab switching function
local currentTab = "Browse"
local tabPages = {
    Browse = BrowsePage,
    Favorites = FavoritesPage,
    Settings = SettingsPage
}

local tabButtons = {
    Browse = BrowseTab,
    Favorites = FavoritesTab,
    Settings = SettingsTab
}

local function SwitchTab(tabName)
    if currentTab == tabName then return end
    
    -- Update button colors
    SmoothTween(tabButtons[currentTab], {
        BackgroundColor3 = Color3.fromRGB(30, 30, 35),
        TextColor3 = Color3.fromRGB(150, 150, 150)
    }, 0.2)
    
    SmoothTween(tabButtons[tabName], {
        BackgroundColor3 = Color3.fromRGB(138, 43, 226),
        TextColor3 = Color3.fromRGB(255, 255, 255)
    }, 0.2)
    
    -- Hide old, show new
    tabPages[currentTab].Visible = false
    tabPages[tabName].Visible = true
    
    currentTab = tabName
    Config.LastTab = tabName
    SaveConfig()
end

-- Set initial tab
SmoothTween(tabButtons[Config.LastTab or "Browse"], {
    BackgroundColor3 = Color3.fromRGB(138, 43, 226),
    TextColor3 = Color3.fromRGB(255, 255, 255)
}, 0)

BrowseTab.MouseButton1Click:Connect(function() SwitchTab("Browse") end)
FavoritesTab.MouseButton1Click:Connect(function() SwitchTab("Favorites") end)
SettingsTab.MouseButton1Click:Connect(function() SwitchTab("Settings") end)

-- Helper function to get real animation ID
local function GetRealAnimationId(id)
    local ok, obj = pcall(function()
        return game:GetObjects("rbxassetid://" .. tostring(id))
    end)
    if ok and obj and #obj > 0 then
        local anim = obj[1]
        if anim:IsA("Animation") and anim.AnimationId ~= "" then
            local animId = tonumber(anim.AnimationId:match("%d+"))
            return animId or id
        end
    end
    return id
end

-- EMOTE PLAYBACK FUNCTIONS (Based on Gaze Emotes working implementation)
local function LoadAndPlayEmote(id)
    if CurrentEmote then 
        CurrentEmote:Stop(Config.FadeOut) 
    end
    
    local animId
    local ok, result = pcall(function() 
        return game:GetObjects("rbxassetid://" .. tostring(id)) 
    end)
    
    if ok and result and #result > 0 then
        local anim = result[1]
        if anim:IsA("Animation") then
            animId = anim.AnimationId
        else
            animId = "rbxassetid://" .. tostring(id)
        end
    else
        animId = "rbxassetid://" .. tostring(id)
    end
    
    local newAnim = Instance.new("Animation")
    newAnim.AnimationId = animId
    local newTrack = Humanoid:LoadAnimation(newAnim)
    newTrack.Priority = Enum.AnimationPriority.Action4
    
    local weight = Config.Weight
    if weight == 0 then weight = 0.001 end
    
    if Config.StopOtherAnimations then
        for _, t in pairs(Humanoid.Animator:GetPlayingAnimationTracks()) do
            if t.Priority ~= Enum.AnimationPriority.Action4 then
                t:Stop()
            end
        end
    end
    
    -- Set running state based on MoveWhileEmoting setting
    Humanoid:SetStateEnabled(Enum.HumanoidStateType.Running, Config.MoveWhileEmoting)
    
    newTrack:Play(Config.FadeIn, weight, Config.EmoteSpeed)
    CurrentEmote = newTrack 
    CurrentEmote.TimePosition = math.clamp(Config.TimePosition, 0, 1) * (CurrentEmote.Length or 1)
    CurrentEmote.Priority = Enum.AnimationPriority.Action4
    CurrentEmote.Looped = Config.LoopEmote
    CurrentlyPlaying = true
    
    CurrentEmote.Stopped:Connect(function()
        CurrentlyPlaying = false
        Humanoid:SetStateEnabled(Enum.HumanoidStateType.Running, true)
    end)
    
    return newTrack
end

local function StopEmote()
    if CurrentEmote then
        CurrentEmote:Stop(Config.FadeOut)
        CurrentEmote = nil
    end
    CurrentlyPlaying = false
    Humanoid:SetStateEnabled(Enum.HumanoidStateType.Running, true)
end

-- Movement detection for stopping emote
RunService.RenderStepped:Connect(function()
    if Config.LoopEmote and CurrentEmote and CurrentEmote.IsPlaying then
        CurrentEmote.Looped = Config.LoopEmote
    end

    if Character:FindFirstChild("HumanoidRootPart") then
        local root = Character.HumanoidRootPart
        if Config.StopEmoteWhenMoving and CurrentEmote and CurrentEmote.IsPlaying then
            local moved = (root.Position - lastPosition).Magnitude > 0.1
            local jumped = Humanoid and Humanoid:GetState() == Enum.HumanoidStateType.Jumping
            if moved or jumped then
                CurrentEmote:Stop(Config.FadeOut)
                CurrentEmote = nil
                CurrentlyPlaying = false
            end
        end
        lastPosition = root.Position
    end
end)

-- CATALOG SCRAPING FUNCTIONS
local sortModes = {
    {Enum.CatalogSortType.Relevance, "Relevance"},
    {Enum.CatalogSortType.MostFavorited, "Most Favorited"},
    {Enum.CatalogSortType.RecentlyCreated, "Recently Created"},
    {Enum.CatalogSortType.Bestselling, "Bestselling"},
}
local currentSortIndex = 1

local function GetCatalogPages(keyword)
    local params = CatalogSearchParams.new()
    params.SearchKeyword = keyword or ""
    params.CategoryFilter = Enum.CatalogCategoryFilter.None
    params.SalesTypeFilter = Enum.SalesTypeFilter.All
    params.AssetTypes = { Enum.AvatarAssetType.EmoteAnimation }
    params.IncludeOffSale = true
    params.SortType = sortModes[currentSortIndex][1]
    params.Limit = 30
    
    local ok, pages = pcall(function()
        return AvatarEditorService:SearchCatalog(params)
    end)
    
    if not ok then
        return nil
    end
    return pages
end

local function FetchEmotesFromCatalog()
    local allEmotes = {}
    local pagesFetched = 0
    local maxPages = 10 -- Fetch 10 pages for good variety
    
    IsLoadingEmotes = true
    LoadingIndicator.Visible = true
    LoadingIndicator.Text = "Loading catalog..."
    
    print("[$errated] Starting catalog fetch...")
    
    local pages = GetCatalogPages("")
    if not pages then
        print("[$errated] Failed to get catalog pages")
        IsLoadingEmotes = false
        LoadingIndicator.Visible = false
        return allEmotes
    end
    
    while pagesFetched < maxPages do
        local success, currentList = pcall(function() 
            return pages:GetCurrentPage() 
        end)
        
        if success and currentList and #currentList > 0 then
            for _, item in ipairs(currentList) do
                local realId = GetRealAnimationId(item.Id)
                
                table.insert(allEmotes, {
                    Name = item.Name or "Unknown Emote",
                    Id = item.Id,
                    AssetId = item.AssetId or item.Id,
                    AnimationId = "rbxassetid://" .. tostring(realId),
                    Creator = item.CreatorName or "Roblox"
                })
            end
            
            LoadingIndicator.Text = string.format("Loaded %d emotes...", #allEmotes)
            pagesFetched = pagesFetched + 1
            
            -- Try to advance to next page
            if not pages.IsFinished then
                local advanceSuccess = pcall(function()
                    pages:AdvanceToNextPageAsync()
                end)
                if not advanceSuccess then
                    break
                end
                wait(0.3) -- Rate limiting
            else
                break
            end
        else
            break
        end
        
        -- Let UI update
        RunService.RenderStepped:Wait()
    end
    
    print(string.format("[$errated] Loaded %d emotes from catalog", #allEmotes))
    
    IsLoadingEmotes = false
    LoadingIndicator.Visible = false
    
    return allEmotes
end

-- Create emote button
local function CreateEmoteButton(parent, emote)
    local button = Instance.new("TextButton")
    button.Name = emote.Name
    button.Size = UDim2.new(1, -10, 0, 50)
    button.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    button.BorderSizePixel = 0
    button.Text = ""
    button.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = button
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, -100, 1, 0)
    nameLabel.Position = UDim2.new(0, 10, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = emote.Name
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    nameLabel.TextSize = 14
    nameLabel.Font = Enum.Font.Gotham
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
    nameLabel.Parent = button
    
    local favoriteBtn = Instance.new("TextButton")
    favoriteBtn.Size = UDim2.new(0, 40, 0, 40)
    favoriteBtn.Position = UDim2.new(1, -85, 0.5, -20)
    favoriteBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    favoriteBtn.BorderSizePixel = 0
    favoriteBtn.Text = table.find(Config.FavoriteEmotes, emote.Id) and "‚≠ê" or "‚òÜ"
    favoriteBtn.TextColor3 = Color3.fromRGB(255, 215, 0)
    favoriteBtn.TextSize = 18
    favoriteBtn.Font = Enum.Font.GothamBold
    favoriteBtn.Parent = button
    
    local favCorner = Instance.new("UICorner")
    favCorner.CornerRadius = UDim.new(0, 6)
    favCorner.Parent = favoriteBtn
    
    local playBtn = Instance.new("TextButton")
    playBtn.Size = UDim2.new(0, 40, 0, 40)
    playBtn.Position = UDim2.new(1, -40, 0.5, -20)
    playBtn.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
    playBtn.BorderSizePixel = 0
    playBtn.Text = "‚ñ∂"
    playBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    playBtn.TextSize = 16
    playBtn.Font = Enum.Font.GothamBold
    playBtn.Parent = button
    
    local playCorner = Instance.new("UICorner")
    playCorner.CornerRadius = UDim.new(0, 6)
    playCorner.Parent = playBtn
    
    -- Button hover effect
    button.MouseEnter:Connect(function()
        SmoothTween(button, {BackgroundColor3 = Color3.fromRGB(40, 40, 45)}, 0.2)
    end)
    
    button.MouseLeave:Connect(function()
        SmoothTween(button, {BackgroundColor3 = Color3.fromRGB(30, 30, 35)}, 0.2)
    end)
    
    -- Play button
    playBtn.MouseButton1Click:Connect(function()
        LoadAndPlayEmote(emote.Id)
        SmoothTween(playBtn, {BackgroundColor3 = Color3.fromRGB(75, 0, 130)}, 0.1)
        wait(0.1)
        SmoothTween(playBtn, {BackgroundColor3 = Color3.fromRGB(138, 43, 226)}, 0.1)
    end)
    
    -- Favorite button
    favoriteBtn.MouseButton1Click:Connect(function()
        local isFavorited = table.find(Config.FavoriteEmotes, emote.Id)
        if isFavorited then
            table.remove(Config.FavoriteEmotes, isFavorited)
            favoriteBtn.Text = "‚òÜ"
        else
            table.insert(Config.FavoriteEmotes, emote.Id)
            favoriteBtn.Text = "‚≠ê"
        end
        SaveConfig()
        
        -- Refresh favorites page
        for _, child in ipairs(FavoritesScrollFrame:GetChildren()) do
            if child:IsA("TextButton") then
                child:Destroy()
            end
        end
        
        for _, e in ipairs(EmotesList) do
            if table.find(Config.FavoriteEmotes, e.Id) then
                CreateEmoteButton(FavoritesScrollFrame, e)
            end
        end
        
        FavoritesScrollFrame.CanvasSize = UDim2.new(0, 0, 0, FavoritesListLayout.AbsoluteContentSize.Y + 10)
    end)
    
    return button
end

-- Create settings controls
local function CreateToggleSetting(name, configKey, yPos)
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, -10, 0, 50)
    container.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    container.BorderSizePixel = 0
    container.LayoutOrder = yPos
    container.Parent = SettingsScrollFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = container
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -70, 1, 0)
    label.Position = UDim2.new(0, 10, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = name
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 14
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = container
    
    local toggle = Instance.new("TextButton")
    toggle.Size = UDim2.new(0, 50, 0, 30)
    toggle.Position = UDim2.new(1, -60, 0.5, -15)
    toggle.BackgroundColor3 = Config[configKey] and Color3.fromRGB(138, 43, 226) or Color3.fromRGB(60, 60, 65)
    toggle.BorderSizePixel = 0
    toggle.Text = ""
    toggle.Parent = container
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(1, 0)
    toggleCorner.Parent = toggle
    
    local indicator = Instance.new("Frame")
    indicator.Size = UDim2.new(0, 24, 0, 24)
    indicator.Position = Config[configKey] and UDim2.new(1, -27, 0.5, -12) or UDim2.new(0, 3, 0.5, -12)
    indicator.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    indicator.BorderSizePixel = 0
    indicator.Parent = toggle
    
    local indicatorCorner = Instance.new("UICorner")
    indicatorCorner.CornerRadius = UDim.new(1, 0)
    indicatorCorner.Parent = indicator
    
    toggle.MouseButton1Click:Connect(function()
        Config[configKey] = not Config[configKey]
        SaveConfig()
        
        SmoothTween(toggle, {
            BackgroundColor3 = Config[configKey] and Color3.fromRGB(138, 43, 226) or Color3.fromRGB(60, 60, 65)
        }, 0.2)
        
        SmoothTween(indicator, {
            Position = Config[configKey] and UDim2.new(1, -27, 0.5, -12) or UDim2.new(0, 3, 0.5, -12)
        }, 0.2)
    end)
    
    return container
end

local function CreateSliderSetting(name, configKey, minVal, maxVal, yPos)
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, -10, 0, 70)
    container.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    container.BorderSizePixel = 0
    container.LayoutOrder = yPos
    container.Parent = SettingsScrollFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = container
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -20, 0, 25)
    label.Position = UDim2.new(0, 10, 0, 5)
    label.BackgroundTransparency = 1
    label.Text = name
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 14
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = container
    
    local valueLabel = Instance.new("TextLabel")
    valueLabel.Size = UDim2.new(0, 50, 0, 25)
    valueLabel.Position = UDim2.new(1, -60, 0, 5)
    valueLabel.BackgroundTransparency = 1
    valueLabel.Text = string.format("%.2f", Config[configKey])
    valueLabel.TextColor3 = Color3.fromRGB(138, 43, 226)
    valueLabel.TextSize = 14
    valueLabel.Font = Enum.Font.GothamBold
    valueLabel.TextXAlignment = Enum.TextXAlignment.Right
    valueLabel.Parent = container
    
    local sliderBg = Instance.new("Frame")
    sliderBg.Size = UDim2.new(1, -20, 0, 6)
    sliderBg.Position = UDim2.new(0, 10, 1, -20)
    sliderBg.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
    sliderBg.BorderSizePixel = 0
    sliderBg.Parent = container
    
    local sliderBgCorner = Instance.new("UICorner")
    sliderBgCorner.CornerRadius = UDim.new(1, 0)
    sliderBgCorner.Parent = sliderBg
    
    local sliderFill = Instance.new("Frame")
    sliderFill.Size = UDim2.new((Config[configKey] - minVal) / (maxVal - minVal), 0, 1, 0)
    sliderFill.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
    sliderFill.BorderSizePixel = 0
    sliderFill.Parent = sliderBg
    
    local sliderFillCorner = Instance.new("UICorner")
    sliderFillCorner.CornerRadius = UDim.new(1, 0)
    sliderFillCorner.Parent = sliderFill
    
    local sliderButton = Instance.new("TextButton")
    sliderButton.Size = UDim2.new(0, 18, 0, 18)
    sliderButton.Position = UDim2.new((Config[configKey] - minVal) / (maxVal - minVal), -9, 0.5, -9)
    sliderButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    sliderButton.BorderSizePixel = 0
    sliderButton.Text = ""
    sliderButton.Parent = sliderBg
    
    local sliderButtonCorner = Instance.new("UICorner")
    sliderButtonCorner.CornerRadius = UDim.new(1, 0)
    sliderButtonCorner.Parent = sliderButton
    
    local draggingSlider = false
    
    sliderButton.MouseButton1Down:Connect(function()
        draggingSlider = true
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            draggingSlider = false
        end
    end)
    
    sliderBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            draggingSlider = true
        end
    end)
    
    RunService.RenderStepped:Connect(function()
        if draggingSlider then
            local mousePos = UserInputService:GetMouseLocation().X
            local sliderPos = sliderBg.AbsolutePosition.X
            local sliderSize = sliderBg.AbsoluteSize.X
            local relative = math.clamp((mousePos - sliderPos) / sliderSize, 0, 1)
            local value = minVal + (relative * (maxVal - minVal))
            
            Config[configKey] = value
            SaveConfig()
            
            valueLabel.Text = string.format("%.2f", value)
            sliderFill.Size = UDim2.new(relative, 0, 1, 0)
            sliderButton.Position = UDim2.new(relative, -9, 0.5, -9)
            
            if CurrentEmote and CurrentEmote.IsPlaying then
                if configKey == "EmoteSpeed" then
                    CurrentEmote:AdjustSpeed(value)
                elseif configKey == "Weight" then
                    local weight = value
                    if weight == 0 then weight = 0.001 end
                    CurrentEmote:AdjustWeight(weight)
                end
            end
        end
    end)
    
    return container
end

-- Populate settings
CreateToggleSetting("Loop Emote", "LoopEmote", 1)
CreateToggleSetting("Move While Emoting", "MoveWhileEmoting", 2)
CreateToggleSetting("Stop Emote When Moving", "StopEmoteWhenMoving", 3)
CreateToggleSetting("Stop Other Animations", "StopOtherAnimations", 4)
CreateSliderSetting("Emote Speed", "EmoteSpeed", 0.1, 3, 5)
CreateSliderSetting("Weight", "Weight", 0, 1, 6)
CreateSliderSetting("Fade In", "FadeIn", 0, 2, 7)
CreateSliderSetting("Fade Out", "FadeOut", 0, 2, 8)

-- Update canvas size for settings
SettingsScrollFrame.CanvasSize = UDim2.new(0, 0, 0, SettingsListLayout.AbsoluteContentSize.Y + 10)
SettingsListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    SettingsScrollFrame.CanvasSize = UDim2.new(0, 0, 0, SettingsListLayout.AbsoluteContentSize.Y + 10)
end)

-- Load emotes function
local function LoadAllEmotes()
    EmotesList = FetchEmotesFromCatalog()
    FilteredEmotes = EmotesList
    
    -- Clear existing buttons
    for _, child in ipairs(EmotesScrollFrame:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    -- Populate browse page
    for _, emote in ipairs(EmotesList) do
        CreateEmoteButton(EmotesScrollFrame, emote)
    end
    
    -- Update canvas size
    EmotesScrollFrame.CanvasSize = UDim2.new(0, 0, 0, EmotesListLayout.AbsoluteContentSize.Y + 10)
    
    -- Populate favorites page
    for _, emote in ipairs(EmotesList) do
        if table.find(Config.FavoriteEmotes, emote.Id) then
            CreateEmoteButton(FavoritesScrollFrame, emote)
        end
    end
    
    FavoritesScrollFrame.CanvasSize = UDim2.new(0, 0, 0, FavoritesListLayout.AbsoluteContentSize.Y + 10)
end

-- Update canvas sizes
EmotesListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    EmotesScrollFrame.CanvasSize = UDim2.new(0, 0, 0, EmotesListLayout.AbsoluteContentSize.Y + 10)
end)

FavoritesListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    FavoritesScrollFrame.CanvasSize = UDim2.new(0, 0, 0, FavoritesListLayout.AbsoluteContentSize.Y + 10)
end)

-- Search functionality
SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
    local searchText = SearchBox.Text:lower()
    
    for _, child in ipairs(EmotesScrollFrame:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    FilteredEmotes = {}
    for _, emote in ipairs(EmotesList) do
        if emote.Name:lower():find(searchText, 1, true) then
            table.insert(FilteredEmotes, emote)
            CreateEmoteButton(EmotesScrollFrame, emote)
        end
    end
end)

-- Toggle UI with G key
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Config.ToggleKey then
        ScreenGui.Enabled = not ScreenGui.Enabled
    end
end)

-- Character respawn handler
Player.CharacterAdded:Connect(function(char)
    Character = char
    Humanoid = Character:WaitForChild("Humanoid")
    HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
    lastPosition = HumanoidRootPart.Position
    StopEmote()
end)

-- Initial animation
MainFrame.Size = UDim2.new(0, 0, 0, 0)
MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
SmoothTween(MainFrame, {
    Size = originalSize,
    Position = UDim2.new(0.5, -350, 0.5, -250)
}, 0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out)

-- Load emotes after UI is ready
spawn(function()
    wait(0.5)
    LoadAllEmotes()
end)

print("[$errated Emotes] Loaded successfully!")
print("[$errated Emotes] Press " .. Config.ToggleKey.Name .. " to toggle UI")
print("[$errated Emotes] Loading full emote catalog...")
